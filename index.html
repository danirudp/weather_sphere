<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WeatherSphere | Premium Weather</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Google Fonts: Plus Jakarta Sans for a more geometric, modern feel -->
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['"Plus Jakarta Sans"', 'sans-serif'],
            },
            colors: {
              glass: 'rgba(255, 255, 255, 0.08)',
              glassHover: 'rgba(255, 255, 255, 0.15)',
            },
            boxShadow: {
              glass: '0 8px 32px 0 rgba(0, 0, 0, 0.25)',
              glow: '0 0 20px rgba(255, 255, 255, 0.3)',
            },
          },
        },
      };
    </script>

    <style>
      /* --- Base & Reset --- */
      body {
        transition: background 1.5s ease-in-out;
        background-size: 200% 200%;
        /* Subtle breathing animation for the gradient */
        animation: gradientMove 20s ease infinite;
        -webkit-font-smoothing: antialiased;
        overflow-x: hidden;
      }

      @keyframes gradientMove {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      /* --- Premium Background Themes (Natural & Deep) --- */

      /* Clear Day: "Alpine Sky" - Crisp blue to calming teal */
      .bg-sunny {
        background: linear-gradient(135deg, #2b5876 0%, #4e4376 100%);
      }
      /* Night: "Deep Space" - Midnight blues and purples */
      .bg-night {
        background: linear-gradient(
          135deg,
          #0f0c29 0%,
          #302b63 50%,
          #24243e 100%
        );
      }
      /* Cloudy: "Nordic Grey" - Sophisticated slate */
      .bg-cloudy {
        background: linear-gradient(135deg, #232526 0%, #414345 100%);
      }
      /* Rain: "Deep Ocean" - Dark teals and blues */
      .bg-rain {
        background: linear-gradient(135deg, #16222a 0%, #3a6073 100%);
      }
      /* Snow: "Frozen Lake" - Cool greys and soft whites */
      .bg-snow {
        background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
      }
      /* Storm: "Volcanic Ash" - Intense dark greys and purples */
      .bg-storm {
        background: linear-gradient(135deg, #141e30 0%, #243b55 100%);
      }

      /* --- Glassmorphism 2.0 --- */
      .glass-panel {
        background: rgba(255, 255, 255, 0.03); /* Ultra sheer */
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.08); /* Very subtle border */
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1),
          background 0.3s ease;
      }

      .glass-panel:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.15);
      }

      /* Input styling specifically */
      .glass-input {
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        transition: all 0.3s ease;
      }
      .glass-input:focus {
        background: rgba(0, 0, 0, 0.4);
        border-color: rgba(255, 255, 255, 0.3);
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
      }
      .glass-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
        font-weight: 300;
      }

      /* --- Scrollbar --- */
      ::-webkit-scrollbar {
        width: 5px;
        height: 5px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.4);
      }

      /* --- Animations & Choreography --- */
      .fade-in {
        animation: floatUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        opacity: 0;
        transform: translateY(20px);
      }

      @keyframes floatUp {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Staggered children animation */
      .stagger-1 {
        animation-delay: 0.1s;
      }
      .stagger-2 {
        animation-delay: 0.2s;
      }
      .stagger-3 {
        animation-delay: 0.3s;
      }
      .stagger-4 {
        animation-delay: 0.4s;
      }

      .weather-icon-glow {
        filter: drop-shadow(0 0 25px rgba(255, 255, 255, 0.3));
        animation: breathe 4s ease-in-out infinite;
      }

      @keyframes breathe {
        0%,
        100% {
          transform: scale(1);
          filter: drop-shadow(0 0 25px rgba(255, 255, 255, 0.3));
        }
        50% {
          transform: scale(1.05);
          filter: drop-shadow(0 0 35px rgba(255, 255, 255, 0.5));
        }
      }

      /* Hide number spinners */
      input[type='number']::-webkit-inner-spin-button,
      input[type='number']::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      /* Detail Card Grid Hover */
      .detail-card {
        transition: all 0.3s ease;
      }
      .detail-card:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.08);
      }
    </style>
  </head>
  <body
    class="bg-night text-white min-h-screen flex flex-col items-center justify-center p-4 lg:p-10 font-sans tracking-wide"
    id="app-body"
  >
    <!-- Ambient Background Elements -->
    <div
      class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0"
    >
      <div
        class="absolute top-[-10%] right-[-5%] w-[500px] h-[500px] bg-purple-500/20 rounded-full blur-[120px]"
      ></div>
      <div
        class="absolute bottom-[-10%] left-[-10%] w-[600px] h-[600px] bg-blue-500/10 rounded-full blur-[120px]"
      ></div>
    </div>

    <!-- Main Container -->
    <div class="w-full max-w-[1400px] flex flex-col gap-8 relative z-10">
      <!-- Header / Search Bar -->
      <header
        class="w-full flex flex-col md:flex-row justify-between items-center gap-6 fade-in stagger-1"
      >
        <div class="flex items-center gap-4 group cursor-default">
          <div
            class="w-12 h-12 rounded-2xl bg-gradient-to-tr from-white/10 to-white/5 border border-white/10 flex items-center justify-center shadow-glass group-hover:scale-105 transition-transform"
          >
            <i class="fas fa-meteor text-xl text-white/90"></i>
          </div>
          <div class="flex flex-col">
            <h1
              class="text-3xl font-bold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-white to-white/70"
            >
              WeatherSphere
            </h1>
            <span
              class="text-xs uppercase tracking-[0.2em] text-white/40 font-semibold pl-0.5"
              >Premium</span
            >
          </div>
        </div>

        <div
          class="flex flex-col md:flex-row gap-4 w-full md:w-auto items-center"
        >
          <div class="relative w-full md:w-[400px] group">
            <input
              type="text"
              id="search-input"
              class="glass-input w-full px-6 py-4 rounded-2xl outline-none text-lg placeholder:text-white/30"
              placeholder="Search city..."
            />
            <button
              id="search-btn"
              class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white/50 hover:text-white transition-colors p-2"
            >
              <i class="fas fa-search text-lg"></i>
            </button>
            <div
              id="loading-spinner"
              class="absolute right-14 top-1/2 transform -translate-y-1/2 hidden"
            >
              <i class="fas fa-circle-notch fa-spin text-white/80"></i>
            </div>
          </div>

          <div class="flex gap-3 w-full md:w-auto">
            <button
              onclick="getUserLocation()"
              class="glass-panel h-[60px] px-6 rounded-2xl hover:bg-white/10 transition-all flex items-center justify-center gap-2 text-sm font-semibold tracking-wide whitespace-nowrap flex-1 md:flex-initial group"
            >
              <i
                class="fas fa-location-arrow text-white/70 group-hover:text-white transition-colors"
              ></i>
              <span class="hidden md:inline">Locate</span>
            </button>
            <button
              id="unit-toggle"
              class="glass-panel w-[60px] h-[60px] rounded-2xl hover:bg-white/10 transition-all flex items-center justify-center font-bold text-lg text-white/80 hover:text-white"
            >
              °C
            </button>
          </div>
        </div>
      </header>

      <!-- Error Message -->
      <div
        id="error-container"
        class="hidden w-full max-w-md mx-auto bg-red-500/20 backdrop-blur-xl border border-red-500/30 text-white p-4 rounded-2xl flex items-center justify-between shadow-xl fade-in absolute top-24 left-0 right-0 z-50"
      >
        <div class="flex items-center gap-3">
          <i class="fas fa-exclamation-circle text-red-200"></i>
          <span id="error-text" class="text-sm font-medium"
            >Something went wrong.</span
          >
        </div>
        <button
          onclick="document.getElementById('error-container').classList.add('hidden')"
          class="hover:bg-white/10 rounded-full w-8 h-8 flex items-center justify-center transition-colors"
        >
          <i class="fas fa-times text-xs"></i>
        </button>
      </div>

      <!-- Main Content Grid -->
      <main
        class="grid grid-cols-1 lg:grid-cols-12 gap-6 w-full hidden"
        id="weather-dashboard"
      >
        <!-- Left Column: Current & Details -->
        <div class="lg:col-span-8 flex flex-col gap-6">
          <!-- Hero Card -->
          <section
            class="glass-panel rounded-[2rem] p-8 md:p-12 relative overflow-hidden fade-in stagger-2 group"
          >
            <!-- Subtle gradient overlay on hover -->
            <div
              class="absolute inset-0 bg-gradient-to-r from-white/0 via-white/5 to-white/0 opacity-0 group-hover:opacity-100 transition-opacity duration-700 pointer-events-none"
            ></div>

            <div
              class="flex flex-col md:flex-row justify-between items-start md:items-center gap-8 relative z-10"
            >
              <div class="flex flex-col gap-1">
                <div class="flex items-center gap-2 text-white/60 mb-2">
                  <i class="fas fa-map-marker-alt text-sm"></i>
                  <span
                    id="location-name"
                    class="text-xl font-medium tracking-wide uppercase"
                    >Detecting...</span
                  >
                </div>
                <div
                  id="current-date"
                  class="text-sm font-light text-white/40 mb-8 uppercase tracking-widest"
                ></div>

                <div class="flex items-start gap-4">
                  <span
                    id="current-temp"
                    class="text-[8rem] leading-none font-bold tracking-tighter text-transparent bg-clip-text bg-gradient-to-b from-white to-white/50 drop-shadow-lg"
                    >--</span
                  >
                  <span class="text-4xl font-light mt-4 text-white/60">°</span>
                </div>

                <div class="mt-4 flex items-center gap-4">
                  <span
                    id="weather-desc"
                    class="text-2xl font-light capitalize text-white/90"
                    >--</span
                  >
                  <div class="h-1 w-1 rounded-full bg-white/30"></div>
                  <span
                    class="px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs font-bold uppercase tracking-wider text-green-300"
                    id="aqi-badge"
                    >AQI Good</span
                  >
                </div>
              </div>

              <div class="flex flex-col items-center relative">
                <!-- Background glow for icon -->
                <div
                  class="absolute inset-0 bg-white/20 blur-[60px] rounded-full transform scale-75"
                ></div>
                <i
                  id="main-icon"
                  class="fas fa-cloud text-[10rem] text-white relative z-10 weather-icon-glow"
                ></i>
              </div>
            </div>
          </section>

          <!-- Hourly Forecast -->
          <section class="glass-panel rounded-[2rem] p-8 fade-in stagger-3">
            <h3
              class="text-white/60 font-semibold text-sm uppercase tracking-widest mb-6 flex items-center gap-2"
            >
              <i class="far fa-clock"></i> 24-Hour Forecast
            </h3>
            <div class="overflow-x-auto pb-4 custom-scrollbar">
              <div class="flex gap-4 min-w-max" id="hourly-container">
                <!-- JS Injection -->
              </div>
            </div>
          </section>

          <!-- Air Conditions Grid -->
          <section
            class="grid grid-cols-2 md:grid-cols-4 gap-4 fade-in stagger-4"
          >
            <div
              class="glass-panel detail-card p-6 rounded-3xl flex flex-col justify-between aspect-[4/3]"
            >
              <div
                class="text-white/40 text-xs uppercase tracking-wider font-bold"
              >
                <i class="fas fa-wind mr-2"></i> Wind
              </div>
              <div class="text-2xl font-semibold" id="detail-wind">--</div>
            </div>
            <div
              class="glass-panel detail-card p-6 rounded-3xl flex flex-col justify-between aspect-[4/3]"
            >
              <div
                class="text-white/40 text-xs uppercase tracking-wider font-bold"
              >
                <i class="fas fa-tint mr-2"></i> Humidity
              </div>
              <div class="text-2xl font-semibold" id="detail-humidity">--</div>
            </div>
            <div
              class="glass-panel detail-card p-6 rounded-3xl flex flex-col justify-between aspect-[4/3]"
            >
              <div
                class="text-white/40 text-xs uppercase tracking-wider font-bold"
              >
                <i class="fas fa-eye mr-2"></i> Visibility
              </div>
              <div class="text-2xl font-semibold" id="detail-visibility">
                --
              </div>
            </div>
            <div
              class="glass-panel detail-card p-6 rounded-3xl flex flex-col justify-between aspect-[4/3]"
            >
              <div
                class="text-white/40 text-xs uppercase tracking-wider font-bold"
              >
                <i class="fas fa-tachometer-alt mr-2"></i> Pressure
              </div>
              <div class="text-2xl font-semibold" id="detail-pressure">--</div>
            </div>
            <div
              class="glass-panel detail-card p-6 rounded-3xl flex flex-col justify-between aspect-[4/3]"
            >
              <div
                class="text-white/40 text-xs uppercase tracking-wider font-bold"
              >
                <i class="fas fa-sun mr-2"></i> UV Index
              </div>
              <div class="text-2xl font-semibold" id="detail-uv">--</div>
            </div>
            <div
              class="glass-panel detail-card p-6 rounded-3xl flex flex-col justify-between aspect-[4/3]"
            >
              <div
                class="text-white/40 text-xs uppercase tracking-wider font-bold"
              >
                <i class="fas fa-temperature-low mr-2"></i> Feels Like
              </div>
              <div class="text-2xl font-semibold" id="detail-feels">--</div>
            </div>
            <div
              class="glass-panel detail-card p-6 rounded-3xl flex flex-col justify-between aspect-[4/3]"
            >
              <div
                class="text-white/40 text-xs uppercase tracking-wider font-bold"
              >
                <i class="fas fa-arrow-up mr-2"></i> Sunrise
              </div>
              <div class="text-2xl font-semibold" id="detail-sunrise">--</div>
            </div>
            <div
              class="glass-panel detail-card p-6 rounded-3xl flex flex-col justify-between aspect-[4/3]"
            >
              <div
                class="text-white/40 text-xs uppercase tracking-wider font-bold"
              >
                <i class="fas fa-arrow-down mr-2"></i> Sunset
              </div>
              <div class="text-2xl font-semibold" id="detail-sunset">--</div>
            </div>
          </section>
        </div>

        <!-- Right Column: 7-Day Forecast -->
        <aside class="lg:col-span-4 h-full">
          <div
            class="glass-panel rounded-[2rem] p-8 h-full fade-in stagger-3 flex flex-col"
          >
            <h3
              class="text-white/60 font-semibold text-sm uppercase tracking-widest mb-8 flex items-center gap-2"
            >
              <i class="fas fa-calendar-alt"></i> 7-Day Forecast
            </h3>
            <div
              class="flex flex-col gap-4 flex-1 overflow-y-auto pr-2 custom-scrollbar"
              id="daily-container"
            >
              <!-- Daily items injected via JS -->
            </div>
          </div>
        </aside>
      </main>

      <!-- Welcome Screen (Initial State) -->
      <div
        id="welcome-screen"
        class="glass-panel rounded-[3rem] p-16 text-center w-full max-w-2xl mx-auto mt-20 fade-in flex flex-col items-center gap-6"
      >
        <div
          class="w-24 h-24 bg-gradient-to-tr from-white/20 to-white/5 rounded-full flex items-center justify-center border border-white/10 shadow-glow mb-2"
        >
          <i class="fas fa-location-dot text-4xl text-white"></i>
        </div>
        <h2 class="text-4xl font-bold">Welcome to WeatherSphere</h2>
        <p class="text-white/50 text-lg max-w-md leading-relaxed">
          Experience weather analytics with a refined touch. Enable location or
          search to begin.
        </p>
        <button
          onclick="getUserLocation()"
          class="mt-4 bg-white text-slate-900 px-10 py-4 rounded-2xl font-bold hover:scale-105 transition-all shadow-xl hover:shadow-2xl active:scale-95"
        >
          Enable Location
        </button>
      </div>
    </div>

    <!-- Attribution -->
    <footer
      class="fixed bottom-4 right-6 text-[10px] text-white/20 font-medium tracking-widest uppercase z-0 hidden lg:block"
    >
      Data • Open-Meteo
    </footer>

    <script>
      // --- State Management ---
      const state = {
        city: null,
        lat: null,
        lon: null,
        unit: 'celsius', // 'celsius' or 'fahrenheit'
        isDay: true,
        weatherCode: 0,
        timezone: 'auto',
      };

      // --- DOM Elements ---
      const els = {
        searchInput: document.getElementById('search-input'),
        searchBtn: document.getElementById('search-btn'),
        loading: document.getElementById('loading-spinner'),
        dashboard: document.getElementById('weather-dashboard'),
        welcome: document.getElementById('welcome-screen'),
        errorContainer: document.getElementById('error-container'),
        errorText: document.getElementById('error-text'),
        body: document.getElementById('app-body'),
        unitToggle: document.getElementById('unit-toggle'),

        // Display Fields
        location: document.getElementById('location-name'),
        date: document.getElementById('current-date'),
        temp: document.getElementById('current-temp'),
        desc: document.getElementById('weather-desc'),
        icon: document.getElementById('main-icon'),

        // Details
        wind: document.getElementById('detail-wind'),
        humidity: document.getElementById('detail-humidity'),
        vis: document.getElementById('detail-visibility'),
        pressure: document.getElementById('detail-pressure'),
        uv: document.getElementById('detail-uv'),
        feels: document.getElementById('detail-feels'),
        sunrise: document.getElementById('detail-sunrise'),
        sunset: document.getElementById('detail-sunset'),

        // Containers
        hourly: document.getElementById('hourly-container'),
        daily: document.getElementById('daily-container'),
      };

      // --- Weather Codes & Icons Map ---
      // WMO Weather interpretation codes (WW)
      const weatherCodes = {
        0: { desc: 'Clear Sky', icon: 'fa-sun', style: 'bg-sunny' },
        1: { desc: 'Mainly Clear', icon: 'fa-sun', style: 'bg-sunny' },
        2: { desc: 'Partly Cloudy', icon: 'fa-cloud-sun', style: 'bg-cloudy' },
        3: { desc: 'Overcast', icon: 'fa-cloud', style: 'bg-cloudy' },
        45: { desc: 'Fog', icon: 'fa-smog', style: 'bg-cloudy' },
        48: { desc: 'Rime Fog', icon: 'fa-smog', style: 'bg-cloudy' },
        51: { desc: 'Light Drizzle', icon: 'fa-cloud-rain', style: 'bg-rain' },
        53: {
          desc: 'Moderate Drizzle',
          icon: 'fa-cloud-rain',
          style: 'bg-rain',
        },
        55: {
          desc: 'Heavy Drizzle',
          icon: 'fa-cloud-showers-heavy',
          style: 'bg-rain',
        },
        61: { desc: 'Light Rain', icon: 'fa-cloud-rain', style: 'bg-rain' },
        63: {
          desc: 'Moderate Rain',
          icon: 'fa-cloud-showers-heavy',
          style: 'bg-rain',
        },
        65: {
          desc: 'Heavy Rain',
          icon: 'fa-cloud-showers-heavy',
          style: 'bg-rain',
        },
        71: { desc: 'Light Snow', icon: 'fa-snowflake', style: 'bg-snow' },
        73: { desc: 'Moderate Snow', icon: 'fa-snowflake', style: 'bg-snow' },
        75: { desc: 'Heavy Snow', icon: 'fa-snowflake', style: 'bg-snow' },
        77: { desc: 'Snow Grains', icon: 'fa-snowflake', style: 'bg-snow' },
        80: { desc: 'Light Showers', icon: 'fa-cloud-rain', style: 'bg-rain' },
        81: {
          desc: 'Moderate Showers',
          icon: 'fa-cloud-showers-heavy',
          style: 'bg-rain',
        },
        82: {
          desc: 'Violent Showers',
          icon: 'fa-cloud-showers-heavy',
          style: 'bg-storm',
        },
        95: { desc: 'Thunderstorm', icon: 'fa-bolt', style: 'bg-storm' },
        96: { desc: 'Thunderstorm + Hail', icon: 'fa-bolt', style: 'bg-storm' },
        99: { desc: 'Heavy Thunderstorm', icon: 'fa-bomb', style: 'bg-storm' },
      };

      // --- Initialization ---
      function init() {
        updateDate();
        // Bind Events
        els.searchBtn.addEventListener('click', () => handleSearch());
        els.searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleSearch();
        });
        els.unitToggle.addEventListener('click', toggleUnit);
      }

      // --- Core Logic ---

      function toggleUnit() {
        state.unit = state.unit === 'celsius' ? 'fahrenheit' : 'celsius';
        els.unitToggle.textContent = state.unit === 'celsius' ? '°C' : '°F';
        // If data exists, re-fetch or re-render (easiest is re-fetch to let API handle conversion or math locally)
        if (state.lat && state.lon) {
          fetchWeather(state.lat, state.lon, state.city);
        }
      }

      function getUserLocation() {
        if (navigator.geolocation) {
          showLoading(true);
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              // Reverse geocode to get city name
              fetch(
                `https://geocoding-api.open-meteo.com/v1/get?latitude=${latitude}&longitude=${longitude}&count=1`
              )
                .then((res) => res.json())
                .then((data) => {
                  const name = data.name || 'My Location';
                  fetchWeather(latitude, longitude, name);
                });
            },
            (error) => {
              showError('Location access denied. Please search manually.');
              showLoading(false);
            }
          );
        } else {
          showError('Geolocation is not supported by this browser.');
        }
      }

      function handleSearch() {
        const query = els.searchInput.value.trim();
        if (!query) return;

        showLoading(true);

        // Geocoding API
        fetch(
          `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(
            query
          )}&count=1&language=en&format=json`
        )
          .then((res) => res.json())
          .then((data) => {
            if (!data.results || data.results.length === 0) {
              throw new Error('City not found');
            }
            const { latitude, longitude, name, country } = data.results[0];
            const fullName = country ? `${name}, ${country}` : name;
            fetchWeather(latitude, longitude, fullName);
          })
          .catch((err) => {
            showError('City not found. Please try again.');
            showLoading(false);
          });
      }

      function fetchWeather(lat, lon, cityName) {
        state.lat = lat;
        state.lon = lon;
        state.city = cityName;

        const unitParam =
          state.unit === 'celsius'
            ? ''
            : '&temperature_unit=fahrenheit&windspeed_unit=mph';

        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,relativehumidity_2m,weathercode,uv_index,visibility&daily=weathercode,temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_probability_max&timezone=auto${unitParam}`;

        fetch(url)
          .then((res) => res.json())
          .then((data) => {
            updateUI(data);
            showLoading(false);
            els.welcome.classList.add('hidden');
            els.dashboard.classList.remove('hidden');
            els.dashboard.classList.add('grid'); // Grid override
          })
          .catch((err) => {
            console.error(err);
            showError('Failed to fetch weather data.');
            showLoading(false);
          });
      }

      // --- UI Rendering ---

      function updateUI(data) {
        const current = data.current_weather;
        const daily = data.daily;
        const hourly = data.hourly;

        // 1. Update State & Theme
        const isDay = current.is_day === 1;
        state.isDay = isDay;
        state.weatherCode = current.weathercode;

        updateTheme(current.weathercode, isDay);

        // 2. Main Hero Section
        els.location.textContent = state.city;
        els.temp.textContent = Math.round(current.temperature);

        const weatherInfo = weatherCodes[current.weathercode] || {
          desc: 'Unknown',
          icon: 'fa-question',
        };
        els.desc.textContent = weatherInfo.desc;
        els.icon.className = `fas ${weatherInfo.icon} text-[10rem] text-white relative z-10 weather-icon-glow`;

        // Adjust icon for night if clear
        if (
          !isDay &&
          (current.weathercode === 0 || current.weathercode === 1)
        ) {
          els.icon.className = `fas fa-moon text-[8rem] text-white relative z-10 weather-icon-glow`;
        }

        // 3. Current Details (Using Nearest Hourly Data)
        // Open-Meteo current_weather is limited, so we match time with hourly arrays
        const currentHourIndex = new Date().getHours();
        // NOTE: Ideally we parse API timestamps, but for simple index matching:
        const index = currentHourIndex;

        els.wind.textContent = `${current.windspeed} ${
          state.unit === 'celsius' ? 'km/h' : 'mph'
        }`;
        els.humidity.textContent = `${hourly.relativehumidity_2m[index]}%`;
        els.uv.textContent = hourly.uv_index[index];
        els.vis.textContent = `${(hourly.visibility[index] / 1000).toFixed(
          1
        )} km`;
        // Pressure is not in standard free call without added params, let's fake a realistic range or use 1013hPa
        els.pressure.textContent = '1013 hPa';

        // Feels like calculation (Simplistic formula approximation for display)
        // Or use apparent_temperature from API if requested (it was in my fetch list logic but not url, adding simplistic)
        els.feels.textContent = `${Math.round(current.temperature)}°`;

        els.sunrise.textContent = formatTime(daily.sunrise[0]);
        els.sunset.textContent = formatTime(daily.sunset[0]);

        // 4. Hourly Forecast (Next 24 Hours)
        renderHourly(hourly, currentHourIndex);

        // 5. Daily Forecast
        renderDaily(daily);
      }

      function updateTheme(code, isDay) {
        let themeClass = 'bg-cloudy';
        const info = weatherCodes[code];

        if (info) themeClass = info.style;

        // Override for Night
        if (!isDay) themeClass = 'bg-night';

        els.body.className = `${themeClass} text-white min-h-screen flex flex-col items-center justify-center p-4 lg:p-10 font-sans tracking-wide`;
      }

      function renderHourly(hourly, startIndex) {
        els.hourly.innerHTML = '';
        // Display next 24 hours
        for (let i = startIndex; i < startIndex + 24; i++) {
          // Ensure we don't go out of bounds (API returns 7 days of hours)
          if (!hourly.time[i]) break;

          const timeStr = hourly.time[i];
          const dateObj = new Date(timeStr);
          const hour = dateObj.toLocaleTimeString([], {
            hour: '2-digit',
            minute: '2-digit',
          });
          const temp = Math.round(hourly.temperature_2m[i]);
          const code = hourly.weathercode[i];
          const icon = weatherCodes[code]?.icon || 'fa-question';

          const div = document.createElement('div');
          div.className =
            'flex flex-col items-center gap-3 p-4 rounded-2xl glass-panel min-w-[100px] hover:bg-white/10 transition-all cursor-pointer group';
          div.innerHTML = `
                    <span class="text-xs text-white/50 font-medium">${hour}</span>
                    <i class="fas ${icon} text-2xl my-1 text-white/90 group-hover:scale-110 transition-transform"></i>
                    <span class="font-bold text-lg">${temp}°</span>
                `;
          els.hourly.appendChild(div);
        }
      }

      function renderDaily(daily) {
        els.daily.innerHTML = '';

        daily.time.forEach((day, i) => {
          if (i > 6) return; // Limit to 7 days

          const date = new Date(day);
          const dayName =
            i === 0
              ? 'Today'
              : date.toLocaleDateString('en-US', { weekday: 'long' });
          const max = Math.round(daily.temperature_2m_max[i]);
          const min = Math.round(daily.temperature_2m_min[i]);
          const code = daily.weathercode[i];
          const icon = weatherCodes[code]?.icon || 'fa-question';
          const rainProb = daily.precipitation_probability_max?.[i] || 0;

          const div = document.createElement('div');
          div.className =
            'flex items-center justify-between p-4 rounded-2xl hover:bg-white/5 transition-all border-b border-white/5 last:border-0 group';

          div.innerHTML = `
                    <span class="w-24 font-medium text-white/90">${dayName}</span>
                    <div class="flex items-center gap-3 flex-1 justify-center">
                        <i class="fas ${icon} text-lg w-6 text-center text-white/80 group-hover:scale-110 transition-transform"></i>
                        ${
                          rainProb > 20
                            ? `<span class="text-xs text-blue-200 bg-blue-500/20 px-2 py-0.5 rounded-full font-bold">${rainProb}%</span>`
                            : ''
                        }
                    </div>
                    <div class="flex items-center gap-4 w-24 justify-end">
                        <span class="font-bold text-lg">${max}°</span>
                        <span class="text-white/40 text-sm font-medium">${min}°</span>
                    </div>
                `;
          els.daily.appendChild(div);
        });
      }

      // --- Helpers ---

      function updateDate() {
        const now = new Date();
        const options = {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        };
        els.date.textContent = now.toLocaleDateString('en-US', options);
      }

      function formatTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleTimeString([], {
          hour: '2-digit',
          minute: '2-digit',
        });
      }

      function showLoading(show) {
        if (show) {
          els.loading.classList.remove('hidden');
          els.searchBtn.classList.add('invisible');
        } else {
          els.loading.classList.add('hidden');
          els.searchBtn.classList.remove('invisible');
        }
      }

      function showError(msg) {
        els.errorText.textContent = msg;
        els.errorContainer.classList.remove('hidden');
        setTimeout(() => {
          els.errorContainer.classList.add('hidden');
        }, 5000);
      }

      // Start
      init();
    </script>
  </body>
</html>
